<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retbro Toolkit</title>
<style>
  :root {
    --bg-color: #1e1e2f;
    --card-color: #2c2c3c;
    --text-color: #f0f0f0;
    --accent-color: #4f9dff;
    --hover-color: #3a3a50;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    margin: 0;
    padding: 20px;
  }

  h1 {
    text-align: center;
    margin-bottom: 30px;
  }

  .top-bar {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 20px;
  }

  input[type=text] {
    padding: 8px;
    border-radius: 5px;
    border: none;
    width: 200px;
    outline: none;
  }

  button {
    cursor: pointer;
    padding: 6px 10px;
    border: none;
    border-radius: 5px;
    background-color: var(--accent-color);
    color: white;
    transition: 0.2s;
    font-size: 12px;
  }

  button:hover {
    background-color: #357edb;
  }

  #systemsContainer {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .system-card {
    background: var(--card-color);
    border-radius: 10px;
    overflow: hidden;
    transition: 0.3s;
  }

  .system-header {
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }

  .system-header:hover {
    background: var(--hover-color);
  }

  .system-title {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .system-title img {
    width: 24px;
    height: 24px;
    object-fit: contain;
    border-radius: 4px;
  }

  .links-list {
    list-style: none;
    padding: 0 20px 12px 20px;
    margin: 0;
    display: none;
  }

  .links-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    gap: 5px;
  }

  .links-list a {
    color: var(--accent-color);
    text-decoration: none;
    word-break: break-all;
    flex: 1;
  }

  .links-list a:hover {
    text-decoration: underline;
  }

  .file-input {
    display: none;
  }

  .icon-btn {
    font-size: 10px;
    padding: 4px 6px;
    margin-left: 3px;
  }
</style>
</head>
<body>

<h1>Retbro retbrorl generator</h1>

<div class="top-bar">
  <input type="text" id="newSystemName" placeholder="Enter system name">
  <button onclick="addSystem()">+ Add System</button>
  <button onclick="exportJSON()">Export .retbrorl</button>
  <button onclick="document.getElementById('fileInput').click()">Import .retbrorl</button>
  <input type="file" id="fileInput" class="file-input" accept=".retbrorl,.json" onchange="importJSON(event)">
  <button onclick="document.getElementById('oldFileInput').click()">Convert v1.x (Old Format) to v2+</button>
  <input type="file" id="oldFileInput" class="file-input" accept=".json,.retbrorl" onchange="importOldFormat(event)">
</div>

<div id="systemsContainer"></div>

<script>
let systems = {};

// Add system
function addSystem() {
  const systemName = document.getElementById('newSystemName').value.trim();
  if (!systemName) return alert("Please enter a system name!");
  if (systems[systemName]) return alert("System already exists!");

  systems[systemName] = { sys_image: "", roms: [] };
  document.getElementById('newSystemName').value = '';
  renderSystems();
}

// Edit system name
function editSystemName(oldName) {
  if (oldName === "Retbro") return alert("You cannot rename the Retbro system!");
  const newName = prompt("Enter new name for system:", oldName);
  if (!newName) return;
  if (systems[newName] && newName !== oldName) return alert("System name already exists!");
  systems[newName] = systems[oldName];
  delete systems[oldName];
  renderSystems();
}

// Remove system
function removeSystem(systemName) {
  if (systemName === "Retbro") return alert("You cannot remove the Retbro system!");
  if (confirm(`Are you sure you want to remove ${systemName}?`)) {
    delete systems[systemName];
    renderSystems();
  }
}

// Add ROM
function addLink(systemName) {
  const url = prompt("Enter ROM link for " + systemName + ":");
  if (!url) return;
  systems[systemName].roms.push(url);
  renderSystems();
}

// Edit ROM
function editLink(systemName, index) {
  const newUrl = prompt("Edit ROM link for " + systemName + ":", systems[systemName].roms[index]);
  if (!newUrl) return;
  systems[systemName].roms[index] = newUrl;
  renderSystems();
}

// Remove ROM
function removeLink(systemName, index) {
  systems[systemName].roms.splice(index, 1);
  renderSystems();
}

// Toggle dropdown
function toggleSystem(systemName) {
  const list = document.getElementById('links-' + systemName);
  list.style.display = list.style.display === 'block' ? 'none' : 'block';
}

// Change/Add System Image (via URL)
function changeSystemImage(systemName) {
  const url = prompt("Enter image URL for " + systemName + ". You can also view our asset library: https://optb.short.gy/retbro/assetlib :", systems[systemName].sys_image || "");
  if (!url) return;
  systems[systemName].sys_image = url.trim();
  renderSystems();
}

// Clear system image
function clearSystemImage(systemName) {
  systems[systemName].sys_image = "";
  renderSystems();
}

// Render all systems
function renderSystems() {
  const container = document.getElementById('systemsContainer');
  container.innerHTML = '';

  for (const systemName in systems) {
    const sysData = systems[systemName];

    const card = document.createElement('div');
    card.className = 'system-card';

    card.innerHTML = `
      <div class="system-header" onclick="toggleSystem('${systemName}')">
        <div class="system-title">
          ${sysData.sys_image ? `<img src="${sysData.sys_image}" alt="icon">` : ''}
          <h2>${systemName}</h2>
        </div>
        <div>
          <button class="icon-btn" onclick="event.stopPropagation(); addLink('${systemName}')">ï¼‹</button>
          ${systemName !== "Retbro" ? `
            <button class="icon-btn" onclick="event.stopPropagation(); changeSystemImage('${systemName}')">ðŸ“·</button>
            <button class="icon-btn" onclick="event.stopPropagation(); clearSystemImage('${systemName}')">ðŸ—™</button>
            <button class="icon-btn" onclick="event.stopPropagation(); editSystemName('${systemName}')">âœŽ</button>
            <button class="icon-btn" onclick="event.stopPropagation(); removeSystem('${systemName}')">ðŸ—‘</button>
          ` : ''}
        </div>
      </div>
      <ul class="links-list" id="links-${systemName}">
        ${sysData.roms.map((link, i) => `
          <li>
            <a href="${link}" target="_blank">${link}</a>
            <button class="icon-btn" onclick="event.stopPropagation(); editLink('${systemName}', ${i})">âœŽ</button>
            <button class="icon-btn" onclick="event.stopPropagation(); removeLink('${systemName}', ${i})">ðŸ—‘</button>
          </li>
        `).join('')}
      </ul>
    `;

    container.appendChild(card);
  }
}

// Export JSON
function exportJSON(filename = 'roms.retbrorl') {
  const dataStr = JSON.stringify(systems, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Import JSON (new format)
function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);
      let valid = true;
      for (const k in importedData) {
        const v = importedData[k];
        if (typeof v !== 'object' || !Array.isArray(v.roms)) { valid = false; break; }
      }
      if (!valid) return alert('Imported file is not in the new format. Use the "Import (old format)" button for older files.');

      systems = importedData;
      renderSystems();
    } catch (err) {
      alert("Invalid .retbrorl file!");
    }
  };
  reader.readAsText(file);
}

// Import old format and transform
function importOldFormat(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const oldData = JSON.parse(e.target.result);
      const transformed = transformOldToNew(oldData);
      systems = { ...systems, ...transformed };
      renderSystems();
      const saveName = file.name.replace(/\.(json|retbrorl)$/i, '') + '.retbrorl';
      exportJSON(saveName);
      alert('Imported old-format file, transformed to new format, and exported as "' + saveName + '"');
    } catch (err) {
      alert("Invalid file or JSON parsing error: " + err.message);
    }
  };
  reader.readAsText(file);
}

// Transformation function: old -> new
function transformOldToNew(oldObj) {
  const out = {};
  for (const systemName in oldObj) {
    const entry = oldObj[systemName];
    if (entry && typeof entry === 'object' && Array.isArray(entry.roms)) {
      out[systemName] = entry;
      continue;
    }
    if (Array.isArray(entry)) {
      out[systemName] = { sys_image: "", roms: entry.slice() };
    } else {
      out[systemName] = { sys_image: "", roms: [] };
      if (typeof entry === 'string') out[systemName].roms.push(entry);
    }
  }
  return out;
}

// Example placeholder system
systems["Retbro"] = {
  sys_image: "https://retbro.optb.qzz.io/app/assets/systems/retbro.png",
  roms: [
    "-------------------------------------------------",
    "About Your Current Retbro Romlist",
    "-------------------------------------------------",
    "Author: My Awesome Name",
    "Website: https://YOUR.WEBSITE.OR.GITHUB.PAGES.SITE",
    "Name: My Awesome List",
    "Description: An Awesome List Made By My Awesome",
    "Name With My Awesome And Name",
    "Safari Support: [True]/False",
    "Chromium Support: [True]/False",
    "Recommended Browser: Chromium-Based",
    "Retbro App Support: [True]/False",
    "iOS Support: True/False/[Partial]",
    "Android Support: True/False/[Partial]",
    "Tablet Support: True/False/Partial/[Controller OR Keyboard Required]",
    "Phone Support: True/False/[Partial]/Controller OR Keyboard Required",
    "ROM Sources: NONE (Yet)",
    "Legal: True",
    "-------------------------------------------------",
        "Controls",
    "-------------------------------------------------",
    "ESC: Go Back",
    "Enter: Select It",
    "Arrow Keys: Navigate",
    "-------------------------------------------------",
    "Controls (In Game)",
    "-------------------------------------------------",
    "Press the controller button in game to view all controls",
    "Enter: Pause/Play",
    "Arrow Keys: Move",
    "-------------------------------------------------",
    "About",
    "-------------------------------------------------",
    "This full Retbro song list was provided to you.",
    "The author of this would not like this to be",
    "Redistrubited so please share the website link",
    "instead of the file.",
    "Powered By EmulatorJS",
    "Press The Credits Button In Footer For RetBro Credits",
    "-------------------------------------------------",
    "Systems (Supported)",
    "-------------------------------------------------",
    "NES",
    "SNES",
    "GameBoy",
    "GameBoy Colour",
    "Virtual Boy",
    "Nintendo DS",
    "Atari 5200",
    "Mame 2003",
    "Arcade",
    "Playstation",
    "Atari Jaguar",
    "Atari Lynx",
    "Sega Saturn",
    "Sega Megadrive",
    "Sega Game Gear",
    "Sega CD",
    "Nintendo 64",
    "3do",
    "Atari 7800",
    "Atari 2600",
    "Sega 32x",
    "Sega MasterSystem",
    "Commodore 64",
    "Commodore 128",
    "Commodore Pet",
    "Commodore Plus 4",
    "Commodore Vic20",
    "Commodore Amiga",
    "Colecovision",
    "TurboGrafx 16 (PCE)",
    "pcfx core",
    "ngp core",
    "ws core",
    "PlayStation Portable (NO SAFARI)"
  ]
};

renderSystems();
</script>

</body>
</html>
